<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>English Vocabulary Battle RPG</title>
    <!-- Favicon and App Manifest -->
    <link rel="icon" type="image/svg+xml" href="icon.svg">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1e1b4b">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');

        body {
            background-color: #1a1a2e;
            color: #fff;
            font-family: 'Helvetica Neue', Arial, sans-serif;
            margin: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100vh;
            overflow: hidden;
            touch-action: manipulation;
        }

        .pixel-font { font-family: 'Press Start 2P', cursive; }

        /* Animations */
        .shake { animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shake {
            10%, 90% { transform: translate3d(-1px, 0, 0); }
            20%, 80% { transform: translate3d(2px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
            40%, 60% { transform: translate3d(4px, 0, 0); }
        }

        .flash-red { animation: flash-red 0.3s ease-out; }
        @keyframes flash-red {
            0% { background-color: rgba(255, 0, 0, 0); }
            50% { background-color: rgba(255, 0, 0, 0.4); }
            100% { background-color: rgba(255, 0, 0, 0); }
        }

        .monster-bounce { animation: bounce 2s infinite; }
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .damage-pop, .heal-pop {
            position: absolute;
            font-weight: bold;
            font-size: 2rem;
            animation: float-up 0.8s ease-out forwards;
            pointer-events: none;
            z-index: 60;
            text-shadow: 2px 2px #000;
        }
        .damage-pop { color: #ff4d4d; }
        .heal-pop { color: #4ade80; }

        @keyframes float-up {
            0% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-60px); }
        }

        /* UI Styling */
        .glass-panel {
            background: rgba(15, 23, 42, 0.8);
            backdrop-filter: blur(4px);
            border: 2px solid rgba(71, 85, 105, 0.5);
        }

        input:focus {
            outline: none;
            border-color: #6366f1;
            box-shadow: 0 0 15px rgba(99, 102, 241, 0.4);
        }

        .btn-press {
            transition: transform 0.1s, filter 0.1s;
        }
        .btn-press:active {
            transform: translateY(2px);
            filter: brightness(1.2);
        }
    </style>
</head>
<body>

    <div id="game-container" class="relative w-full max-w-lg h-full sm:h-[95vh] bg-slate-800 sm:rounded-xl shadow-2xl overflow-hidden flex flex-col border-x-4 sm:border-4 border-slate-600 transition-colors duration-300">
        
        <!-- HEADER: Status & Navigation -->
        <div class="p-4 bg-slate-900 flex justify-between items-center border-b-2 border-slate-700 z-50">
            <div class="flex flex-col">
                <span class="text-[10px] text-blue-400 font-bold uppercase tracking-tighter">PLAYER HP</span>
                <div class="w-24 sm:w-32 h-3 bg-gray-700 rounded-full overflow-hidden border border-gray-600">
                    <div id="player-hp-bar" class="h-full bg-green-500 transition-all duration-300" style="width: 100%;"></div>
                </div>
                <span id="player-hp-text" class="text-[10px] mt-1 text-white font-mono">100 / 100</span>
            </div>
            
            <div class="text-center flex flex-col items-center gap-1">
                <div class="flex items-center gap-3">
                    <button id="music-toggle" class="text-xl bg-slate-700 w-8 h-8 rounded-full flex items-center justify-center border border-slate-500 shadow-inner btn-press">üîá</button>
                    <img src="icon.svg" alt="App Icon" class="w-8 h-8 rounded-lg shadow-md border border-slate-500" onerror="this.style.display='none'">
                </div>
                <div class="flex flex-col mt-1">
                    <span id="stage-count" class="text-base font-bold text-yellow-400 pixel-font">1 / 15</span>
                    <span class="text-[8px] text-yellow-600 font-bold uppercase tracking-widest">STAGE</span>
                </div>
            </div>

            <div class="flex flex-col items-end">
                <span class="text-[10px] text-red-400 font-bold uppercase tracking-tighter">ENEMY HP</span>
                <div class="w-24 sm:w-32 h-3 bg-gray-700 rounded-full overflow-hidden border border-gray-600">
                    <div id="enemy-hp-bar" class="h-full bg-red-500 transition-all duration-300" style="width: 100%;"></div>
                </div>
                <span id="enemy-hp-text" class="text-[10px] mt-1 text-white font-mono">0 / 0</span>
            </div>
        </div>

        <!-- BATTLEFIELD -->
        <div class="relative flex-grow bg-gradient-to-b from-indigo-900 to-slate-800 flex flex-col items-center p-4 min-h-[200px]">
            <div class="absolute bottom-10 w-full h-24 bg-slate-950 opacity-20 skew-y-2"></div>
            
            <div id="monster-section" class="flex-grow flex flex-col items-center justify-center">
                <div id="monster-container" class="relative z-10 flex flex-col items-center monster-bounce">
                    <div id="monster-sprite" class="text-8xl sm:text-9xl mb-4 filter drop-shadow-[0_10px_10px_rgba(0,0,0,0.5)] transition-transform duration-300">üëæ</div>
                    <div id="monster-name" class="glass-panel px-4 py-1 rounded-full text-xs sm:text-sm font-bold tracking-widest text-white uppercase shadow-lg">READY?</div>
                </div>
            </div>

            <!-- Recovery Button -->
            <button id="review-trigger-btn" class="hidden absolute top-4 right-4 bg-green-600 hover:bg-green-500 text-white px-4 py-2 rounded-lg font-bold text-xs transition-all z-50 shadow-xl border-b-4 border-green-800 active:border-b-0 active:translate-y-1">
                RECOVER HP
            </button>

            <!-- Message Log -->
            <div id="message-log" class="w-full glass-panel p-3 rounded-lg text-xs sm:text-sm min-h-[56px] flex items-center justify-center text-center text-indigo-100 z-20 shadow-inner border-indigo-500/30">
                ÁîªÈù¢„Çí„Çø„ÉÉ„Éó„Åó„Å¶ÂÜíÈô∫„ÇíÈñãÂßãÔºÅ
            </div>
        </div>

        <!-- ACTION AREA -->
        <div id="action-area" class="bg-slate-900 px-6 pt-5 pb-12 sm:pb-8 flex flex-col gap-4 border-t-4 border-slate-700 relative">
            <div id="question-header" class="text-center">
                <p id="mode-label" class="text-indigo-400 text-[10px] font-bold mb-2 uppercase tracking-widest opacity-80">Battle System</p>
                <div id="question-content" class="flex flex-col items-center justify-center min-h-[80px]">
                    <h2 id="question-display" class="text-3xl sm:text-5xl font-bold text-white tracking-wide">TAP TO START</h2>
                    <button id="listen-btn" class="hidden mt-3 bg-indigo-600 hover:bg-indigo-500 w-12 h-12 rounded-full flex items-center justify-center shadow-lg btn-press">
                        <span class="text-2xl">üîä</span>
                    </button>
                </div>
            </div>

            <!-- Choices -->
            <div id="options-grid" class="grid grid-cols-2 gap-3"></div>

            <!-- Writing UI -->
            <div id="writing-ui" class="hidden flex flex-col gap-3">
                <div class="relative flex items-center gap-2">
                    <input type="text" id="writing-input" autocomplete="off" class="flex-grow bg-slate-800 border-2 border-slate-700 rounded-lg p-4 text-center text-xl sm:text-2xl font-bold text-white uppercase" placeholder="TYPE HERE">
                    <button id="hint-btn" class="bg-amber-600 hover:bg-amber-500 w-14 h-14 rounded-lg font-bold text-white shadow-lg border-b-4 border-amber-800 text-xs">HINT</button>
                </div>
                <button id="submit-btn" class="bg-indigo-600 hover:bg-indigo-500 p-4 rounded-lg font-bold text-white shadow-lg border-b-4 border-indigo-800 btn-press">Ê±∫ÂÆö (ENTER)</button>
            </div>
        </div>

        <!-- Overlays -->
        <div id="overlay-screen" class="hidden absolute inset-0 bg-black/95 z-[100] flex flex-col items-center justify-center p-8 text-center backdrop-blur-sm">
            <h2 id="overlay-title" class="text-4xl sm:text-6xl font-bold mb-6 pixel-font">GAME OVER</h2>
            <p id="overlay-msg" class="text-xl mb-10 text-slate-300">ÂÜíÈô∫„ÅØ„Åì„Åì„ÅßÁµÇ„Çè„Å£„Å¶„Åó„Åæ„Å£„Åü...</p>
            <button onclick="resetGame()" class="bg-yellow-500 hover:bg-yellow-400 text-black font-bold py-4 px-12 rounded-full text-xl transition-transform active:scale-95 shadow-[0_0_20px_rgba(234,179,8,0.4)]">
                ÂÜçÊåëÊà¶„Åô„Çã
            </button>
        </div>
    </div>

    <script>
        /**
         * AUDIO ENGINE
         */
        let audioCtx = null;
        let isMusicPlaying = false;
        let musicLoopId = null;
        let bgmStep = 0;

        function initAudio() {
            if (audioCtx) return;
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        }

        function playTone(freq, duration, type = 'square', volume = 0.1) {
            if (!audioCtx || !isMusicPlaying) return;
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = type;
            osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
            gain.gain.setValueAtTime(volume, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + duration);
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.start();
            osc.stop(audioCtx.currentTime + duration);
        }

        const BGM_MELODIES = [
            [261.63, 329.63, 392.00, 523.25, 392.00, 329.63, 0, 0],
            [293.66, 369.99, 440.00, 293.66, 369.99, 0, 0, 0],
            [392.00, 493.88, 587.33, 392.00, 493.88, 392.00, 0, 0],
            [220.00, 277.18, 329.63, 220.00, 277.18, 0, 0, 0],
            [349.23, 440.00, 523.25, 349.23, 440.00, 349.23, 0, 0],
            [196.00, 246.94, 293.66, 196.00, 246.94, 0, 0, 0],
            [311.13, 392.00, 466.16, 311.13, 392.00, 311.13, 0, 0],
            [174.61, 220.00, 261.63, 174.61, 220.00, 0, 0, 0],
            [261.63, 0, 329.63, 0, 392.00, 0, 523.25, 0],
            [329.63, 392.00, 493.88, 329.63, 392.00, 329.63, 0, 0],
            [233.08, 293.66, 349.23, 233.08, 293.66, 0, 0, 0],
            [392.00, 0, 493.88, 0, 587.33, 0, 783.99, 0],
            [277.18, 349.23, 415.30, 277.18, 349.23, 277.18, 0, 0],
            [523.25, 659.25, 783.99, 523.25, 659.25, 523.25, 0, 0],
            [392.00, 493.88, 587.33, 783.99, 587.33, 493.88, 392.00, 0]
        ];

        function playBGM() {
            if (!isMusicPlaying) return;
            const stageIdx = Math.min((state.stage || 1) - 1, BGM_MELODIES.length - 1);
            const melody = BGM_MELODIES[stageIdx];
            const currentNote = melody[bgmStep % melody.length];
            if (currentNote > 0) {
                playTone(currentNote, 0.5, 'square', 0.04);
                playTone(currentNote/2, 0.3, 'triangle', 0.02);
            }
            bgmStep++;
            musicLoopId = setTimeout(playBGM, 220);
        }

        function toggleMusic() {
            initAudio();
            isMusicPlaying = !isMusicPlaying;
            document.getElementById('music-toggle').innerText = isMusicPlaying ? 'üîä' : 'üîá';
            if (isMusicPlaying) {
                if (audioCtx.state === 'suspended') audioCtx.resume();
                playBGM();
            } else {
                clearTimeout(musicLoopId);
            }
        }

        function playSE(type) {
            if (!isMusicPlaying) return;
            if (type === 'hit') {
                playTone(150, 0.1, 'sawtooth', 0.1);
                playTone(100, 0.2, 'sawtooth', 0.08);
            } else if (type === 'correct') {
                playTone(523.25, 0.08, 'sine', 0.1);
                setTimeout(() => playTone(659.25, 0.08, 'sine', 0.1), 80);
                setTimeout(() => playTone(783.99, 0.15, 'sine', 0.1), 160);
            } else if (type === 'error') {
                playTone(220, 0.3, 'square', 0.1);
                playTone(110, 0.4, 'square', 0.1);
            }
        }

        /**
         * GAME DATA
         */
        const wordList = [
            { en: "hero", ja: "ÂãáËÄÖ" }, { en: "sword", ja: "Ââ£" }, { en: "magic", ja: "È≠îÊ≥ï" }, { en: "enemy", ja: "Êïµ" },
            { en: "dragon", ja: "Á´ú" }, { en: "castle", ja: "Âüé" }, { en: "king", ja: "Áéã" }, { en: "queen", ja: "Â•≥Áéã" },
            { en: "shield", ja: "Áõæ" }, { en: "forest", ja: "Ê£Æ" }, { en: "river", ja: "Â∑ù" }, { en: "mountain", ja: "Â±±" },
            { en: "ocean", ja: "Êµ∑" }, { en: "star", ja: "Êòü" }, { en: "moon", ja: "Êúà" }, { en: "sun", ja: "Â§™ÈôΩ" },
            { en: "fire", ja: "ÁÅ´" }, { en: "water", ja: "Ê∞¥" }, { en: "earth", ja: "Â§ßÂú∞" }, { en: "wind", ja: "È¢®" },
            { en: "battle", ja: "Êà¶Èóò" }, { en: "peace", ja: "Âπ≥Âíå" }, { en: "dream", ja: "Â§¢" }, { en: "light", ja: "ÂÖâ" },
            { en: "dark", ja: "Èóá" }, { en: "friend", ja: "ÂèãÈÅî" }, { en: "power", ja: "Âäõ" }, { en: "gold", ja: "Èáë" }
        ];

        const monsters = [
            { name: "SLIME", emoji: "üëæ", hp: 40 },
            { name: "BAT", emoji: "ü¶á", hp: 55 },
            { name: "SKELETON", emoji: "üíÄ", hp: 70 },
            { name: "GOBLIN", emoji: "üë∫", hp: 85 },
            { name: "ORC", emoji: "üßå", hp: 100 },
            { name: "GOLEM", emoji: "üóø", hp: 120 },
            { name: "WOLF", emoji: "üê∫", hp: 140 },
            { name: "SPIDER", emoji: "üï∑Ô∏è", hp: 160 },
            { name: "VAMPIRE", emoji: "üßõ", hp: 180 },
            { name: "WITCH", emoji: "üßô‚Äç‚ôÄÔ∏è", hp: 200 },
            { name: "GHOST", emoji: "üëª", hp: 230 },
            { name: "MINOTAUR", emoji: "üêÇ", hp: 260 },
            { name: "HYDRA", emoji: "üêâ", hp: 300 },
            { name: "DRAGON", emoji: "üê≤", hp: 350 },
            { name: "DEMON KING", emoji: "üëπ", hp: 400 }
        ];

        let state = {
            playerHp: 100, maxPlayerHp: 100,
            enemyHp: 0, maxEnemyHp: 0,
            stage: 1, currentWord: null, currentMode: 'choice',
            isProcessing: false, isReviewing: false, missedWords: [],
            gameStarted: false
        };

        const elements = {
            playerHpBar: document.getElementById('player-hp-bar'),
            playerHpText: document.getElementById('player-hp-text'),
            enemyHpBar: document.getElementById('enemy-hp-bar'),
            enemyHpText: document.getElementById('enemy-hp-text'),
            stageText: document.getElementById('stage-count'),
            monsterSprite: document.getElementById('monster-sprite'),
            monsterName: document.getElementById('monster-name'),
            message: document.getElementById('message-log'),
            question: document.getElementById('question-display'),
            modeLabel: document.getElementById('mode-label'),
            optionsGrid: document.getElementById('options-grid'),
            writingUI: document.getElementById('writing-ui'),
            writingInput: document.getElementById('writing-input'),
            listenBtn: document.getElementById('listen-btn'),
            reviewBtn: document.getElementById('review-trigger-btn'),
            overlay: document.getElementById('overlay-screen')
        };

        /**
         * GAME LOGIC
         */
        function start() {
            if (state.gameStarted) return;
            state.gameStarted = true;
            initAudio();
            initStage();
        }

        function initStage() {
            if (state.stage > 15) { finishGame(true); return; }
            
            bgmStep = 0;
            if (musicLoopId) { clearTimeout(musicLoopId); musicLoopId = null; }
            if (isMusicPlaying) playBGM();
            
            const baseMonster = monsters[state.stage - 1];
            state.enemyHp = baseMonster.hp + (state.stage * 5);
            state.maxEnemyHp = state.enemyHp;
            
            elements.monsterSprite.innerText = baseMonster.emoji;
            elements.monsterName.innerText = baseMonster.name;
            elements.stageText.innerText = `${state.stage} / 15`;
            
            updateUI();
            nextQuestion();
            elements.message.innerText = `${baseMonster.name} „ÅåÁèæ„Çå„ÅüÔºÅ`;
        }

        function nextQuestion() {
            state.isProcessing = false;
            const modes = ['choice', 'listening', 'writing'];
            state.currentMode = modes[Math.floor(Math.random() * modes.length)];
            
            if (state.isReviewing && state.missedWords.length > 0) {
                state.currentWord = state.missedWords[0];
                elements.modeLabel.innerText = "‚≠ê RECOVERY MODE ‚≠ê";
                elements.modeLabel.className = "text-green-400 text-[10px] font-bold mb-2 uppercase";
            } else {
                state.isReviewing = false;
                state.currentWord = wordList[Math.floor(Math.random() * wordList.length)];
                elements.modeLabel.innerText = state.currentMode.toUpperCase();
                elements.modeLabel.className = "text-indigo-400 text-[10px] font-bold mb-2 uppercase";
            }

            setupUIForMode();
        }

        function setupUIForMode() {
            elements.optionsGrid.innerHTML = '';
            elements.optionsGrid.classList.add('hidden');
            elements.writingUI.classList.add('hidden');
            elements.listenBtn.classList.add('hidden');
            elements.writingInput.value = '';
            elements.writingInput.placeholder = 'TYPE HERE';
            elements.question.classList.remove('text-yellow-400');

            if (state.currentMode === 'choice') {
                elements.question.innerText = state.currentWord.en;
                createChoices(false);
            } else if (state.currentMode === 'listening') {
                elements.question.innerText = "???";
                elements.listenBtn.classList.remove('hidden');
                speak(state.currentWord.en);
                createChoices(true);
            } else {
                elements.question.innerText = state.currentWord.ja;
                elements.writingUI.classList.remove('hidden');
            }
        }

        function createChoices(isEnglish) {
            elements.optionsGrid.classList.remove('hidden');
            let opts = [isEnglish ? state.currentWord.en : state.currentWord.ja];
            while (opts.length < 4) {
                const w = wordList[Math.floor(Math.random() * wordList.length)];
                const val = isEnglish ? w.en : w.ja;
                if (!opts.includes(val)) opts.push(val);
            }
            opts.sort(() => Math.random() - 0.5).forEach(o => {
                const b = document.createElement('button');
                b.className = "bg-slate-700 p-4 rounded-lg font-bold border-b-4 border-slate-900 text-white btn-press text-sm truncate";
                b.innerText = o;
                b.onclick = () => handleAnswer(o);
                elements.optionsGrid.appendChild(b);
            });
        }

        function handleAnswer(ans) {
            if (state.isProcessing) return;
            state.isProcessing = true;

            const isCorrect = state.currentMode === 'choice' 
                ? ans === state.currentWord.ja 
                : ans.toLowerCase().trim() === state.currentWord.en.toLowerCase();

            if (isCorrect) {
                playSE('correct');
                elements.question.innerText = state.currentWord.en;
                elements.question.classList.add('text-yellow-400');
                
                if (state.isReviewing) {
                    healPlayer();
                } else {
                    damageEnemy();
                }
            } else {
                playSE('error');
                if (!state.missedWords.some(w => w.en === state.currentWord.en)) {
                    state.missedWords.push(state.currentWord);
                }
                damagePlayer();
            }
        }

        function damageEnemy() {
            const dmg = 25 + Math.floor(Math.random() * 20);
            state.enemyHp = Math.max(0, state.enemyHp - dmg);
            popText(`-${dmg}`, 'damage-pop');
            elements.monsterSprite.classList.add('shake');
            setTimeout(() => elements.monsterSprite.classList.remove('shake'), 500);
            
            elements.message.innerText = `Ê≠£Ëß£ÔºÅ ${state.currentWord.en} = ${state.currentWord.ja}`;
            updateUI();
            
            setTimeout(() => {
                if (state.enemyHp <= 0) {
                    state.stage++;
                    initStage();
                } else {
                    nextQuestion();
                }
            }, 1000);
        }

        function healPlayer() {
            const heal = 25;
            state.playerHp = Math.min(state.maxPlayerHp, state.playerHp + heal);
            state.missedWords.shift();
            popText(`+${heal}`, 'heal-pop');
            elements.message.innerText = "„É™„Ç´„Éê„É™„ÉºÊàêÂäüÔºÅHPÂõûÂæ©ÔºÅ";
            updateUI();
            setTimeout(nextQuestion, 1000);
        }

        function damagePlayer() {
            const dmg = 15 + (state.stage * 2);
            state.playerHp = Math.max(0, state.playerHp - dmg);
            document.getElementById('game-container').classList.add('flash-red');
            setTimeout(() => document.getElementById('game-container').classList.remove('flash-red'), 300);
            
            elements.message.innerText = `„Éü„ÇπÔºÅÊ≠£Ëß£„ÅØ ${state.currentWord.en}`;
            updateUI();
            
            if (state.playerHp <= 0) {
                setTimeout(() => finishGame(false), 800);
            } else {
                setTimeout(nextQuestion, 2000);
            }
        }

        function popText(txt, cls) {
            const el = document.createElement('div');
            el.className = `${cls} pixel-font`;
            el.innerText = txt;
            el.style.left = '50%';
            el.style.top = '20%';
            document.getElementById('monster-section').appendChild(el);
            setTimeout(() => el.remove(), 800);
        }

        function updateUI() {
            elements.playerHpBar.style.width = `${(state.playerHp / state.maxPlayerHp) * 100}%`;
            elements.playerHpText.innerText = `${state.playerHp} / ${state.maxPlayerHp}`;
            elements.enemyHpBar.style.width = `${(state.enemyHp / state.maxEnemyHp) * 100}%`;
            elements.enemyHpText.innerText = `${state.enemyHp} / ${state.maxEnemyHp}`;
            
            if (state.missedWords.length > 0 && !state.isReviewing && state.playerHp < state.maxPlayerHp) {
                elements.reviewBtn.classList.remove('hidden');
            } else {
                elements.reviewBtn.classList.add('hidden');
            }
        }

        function speak(txt) {
            const u = new SpeechSynthesisUtterance(txt);
            u.lang = 'en-US';
            u.rate = 0.8;
            speechSynthesis.speak(u);
        }

        function finishGame(win) {
            elements.overlay.classList.remove('hidden');
            document.getElementById('overlay-title').innerText = win ? "ALL CLEAR!" : "GAME OVER";
            document.getElementById('overlay-title').className = win ? "text-4xl sm:text-6xl font-bold mb-6 pixel-font text-yellow-400" : "text-4xl sm:text-6xl font-bold mb-6 pixel-font text-red-500";
            document.getElementById('overlay-msg').innerText = win ? "ÂÖ®„Çπ„ÉÜ„Éº„Ç∏Âà∂Ë¶áÔºÅÁúü„ÅÆÂãáËÄÖ„Å†ÔºÅ" : `„Çπ„ÉÜ„Éº„Ç∏ ${state.stage} „ÅßÂäõÂ∞Ω„Åç„Åü...`;
        }

        function resetGame() {
            state = {
                playerHp: 100, maxPlayerHp: 100, enemyHp: 0, maxEnemyHp: 0,
                stage: 1, currentWord: null, currentMode: 'choice',
                isProcessing: false, isReviewing: false, missedWords: [],
                gameStarted: true
            };
            elements.overlay.classList.add('hidden');
            initStage();
        }

        // Event Listeners
        document.body.addEventListener('click', start, { once: false });
        document.getElementById('music-toggle').onclick = (e) => { e.stopPropagation(); toggleMusic(); };
        document.getElementById('submit-btn').onclick = () => handleAnswer(elements.writingInput.value);
        document.getElementById('writing-input').onkeydown = (e) => { if(e.key === 'Enter') handleAnswer(elements.writingInput.value); };
        document.getElementById('hint-btn').onclick = () => { 
            if (!state.currentWord) return;
            const hint = `„Éí„É≥„Éà: ÊúÄÂàù„ÅÆÊñáÂ≠ó„ÅØ "${state.currentWord.en[0].toUpperCase()}"`;
            elements.message.innerText = hint;
            elements.writingInput.placeholder = `START WITH "${state.currentWord.en[0].toUpperCase()}"`;
        };
        elements.listenBtn.onclick = (e) => { e.stopPropagation(); speak(state.currentWord.en); };
        elements.reviewBtn.onclick = (e) => { 
            e.stopPropagation(); 
            state.isReviewing = true; 
            nextQuestion(); 
        };

    </script>
</body>
</html>